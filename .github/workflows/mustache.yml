name: Render Mustache templates

on:
  push:
    branches:
      - develop

jobs:
  build:
    runs-on: ubuntu-18.04

    steps:
      - uses: actions/checkout@v2
        with:
          persist-credentials: false
      - uses: actions/setup-java@v1
        with:
          java-version: '13'
      - name: Set up Kotlin
        run: |-
          sudo snap install --classic kotlin
      - name: Render templates
        run: |-
          kotlinVersion='1.3.70'
          kmsUrl="https://repo1.maven.org/maven2/org/jetbrains/kotlin/kotlin-main-kts/$kotlinVersion/kotlin-main-kts-$kotlinVersion.jar"
          kmsBasename=$(basename $kmsUrl)
          wget -nc $kmsUrl
          echo "Using kotlin-main-kts artifact $kmsBasename ($kotlinVersion)"

          mkdir build/
          cp *.html build/ || :
          cp -r static/ build/ || :

          kotlinc -cp $kmsBasename -script site.main.kts
      - name: Deploy to master
        uses: JamesIves/github-pages-deploy-action@3.4.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: master
          FOLDER: build/
          COMMIT_MESSAGE: Deployed from develop
